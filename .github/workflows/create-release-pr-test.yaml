name: Create Release PR Test

on:
  push:
    branches:
      - develop-test

jobs:
  create-release-pr:
    name: Create Release PR
    runs-on: ubuntu-latest

    steps:
      # - uses: actions/checkout@v3
      # - name: Check if PR exists
      #   env:
      #     GH_TOKEN: ${{ github.token }}
      #   run: |
      #     on_error() {
      #       echo "PR create attempt failed, assuming PR already exists."
      #       exit 0
      #     }

      #     NEWLINE=$'\n'
      #     # trap "on_error" INT TERM ERR
      #     gh pr create --title "Test CI Updates" --body "If this change should result in new package versions please add a changeset before merging. You can do so by clicking the maintainers link provided by changeset-bot below.${NEWLINE}${NEWLINE}Please note that changeset-bot appears to produce inconsistent / incorrect results with the latest version of changesets when run locally. Be sure to check that it is correctly mentioning the changed packages in the referenced link, or produce the changeset locally \`yarn changeset\` and push it to the branch."

      # github.rest.issues.createComment({
      #   issue_number: context.issue.number,
      #   owner: context.repo.owner,
      #   repo: context.repo.repo,
      #   body: 'ðŸ‘‹ Thanks for reporting!'
      # })

      # const { data: pullRequest } = await github.rest.pulls.get({
      #   owner: context.repo.owner,
      #   repo: context.repo.repo,
      # });

      - name: Create Release PR or get existing PR id
        uses: actions/github-script@v5
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = 'develop-test';
            const base = 'main';

            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
            });

            let pr = prs.find((pr) => {
              return pr.head.ref === head && pr.base.ref === base;
            });

            if (!pr) {
              ({ data: pr }) = await github.rest.pulls.create({
                owner,
                repo,
                head,
                base,
                title: 'Test CI Updates',
                body: "If this change should result in new package versions please add a changeset before merging. You can do so by clicking the maintainers link provided by changeset-bot below.\n\nPlease note that changeset-bot appears to produce inconsistent / incorrect results with the latest version of changesets when run locally. Be sure to check that it is correctly mentioning the changed packages in the referenced link, or produce the changeset locally `yarn changeset` and push it to the branch."
              });
            }

            return pr.number;
